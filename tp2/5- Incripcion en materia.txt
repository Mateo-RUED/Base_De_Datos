DELIMITER $$

CREATE FUNCTION verificar_inscripcion_materia(alumno_id INT, materia_id INT)
RETURNS VARCHAR(20)
DETERMINISTIC
BEGIN
    DECLARE estado_actual VARCHAR(20);
    SELECT estado INTO estado_actual
    FROM inscripcion_materia
    WHERE id_alumno = alumno_id
    AND id_materia = materia_id
    LIMIT 1;
    RETURN IFNULL(estado_actual, 'No Inscrito');
END$$

DELIMITER ;
-----------------------------
DELIMITER $$

CREATE PROCEDURE inscribir_en_materia(
    IN nombre VARCHAR(100),
    IN apellido VARCHAR(100),
    IN materia VARCHAR(100),
    IN fecha_inscripcion DATE
)
BEGIN
    DECLARE id_alumno INT;
    DECLARE id_materia INT;
    DECLARE estado_inscripcion VARCHAR(20);

    SET id_alumno = obtener_id_alumno(nombre, apellido);
    SET id_materia = obtener_id_materia(materia);
    
    SET estado_inscripcion = verificar_inscripcion_materia(id_alumno, id_materia);

    IF estado_inscripcion = 'Regular' THEN
        SELECT 'No se puede inscribir. El alumno ya tiene estado Regular en la materia.' AS mensaje;
    ELSEIF estado_inscripcion = 'Cursando' THEN
        SELECT 'No se puede inscribir. El alumno ya está cursando la materia.' AS mensaje;
    ELSEIF estado_inscripcion = 'Libre' OR estado_inscripcion = 'No Inscrito' THEN
        INSERT INTO inscripcion_materia (id_alumno, id_materia, estado, fecha_inscripcion)
        VALUES (id_alumno, id_materia, 'Cursando', fecha_inscripcion);
        
        SELECT 'Inscripción en la materia realizada exitosamente.' AS mensaje;
    ELSE
        SELECT 'Error en el proceso de inscripción.' AS mensaje;
    END IF;
END$$

DELIMITER ;
----------------------------
CALL inscribir_en_materia('Juan', 'Pérez', 'Programacion I', '2024-09-16');
