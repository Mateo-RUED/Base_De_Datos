DELIMITER $$

CREATE FUNCTION tiene_inscripcion_sin_calificacion(id_alumno INT, id_materia INT)
RETURNS BOOLEAN
DETERMINISTIC
BEGIN
    DECLARE tiene_sin_calificacion BOOLEAN;
    SELECT COUNT(*) > 0 INTO tiene_sin_calificacion
    FROM inscripcion_examen ie
    JOIN inscripcion_materia im ON ie.id_alumno = im.id_alumno AND ie.id_mesa = im.id_comision
    WHERE ie.id_alumno = id_alumno
    AND im.id_materia = id_materia
    AND ie.nota IS NULL;
    RETURN tiene_sin_calificacion;
END$$

DELIMITER ;
----------------------------------------------------------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE inscribir_en_examen(
    IN nombre_alumno VARCHAR(100),
    IN apellido_alumno VARCHAR(100),
    IN nombre_materia VARCHAR(100),
    IN id_mesa INT,
    IN fecha_inscripcion DATE
)
BEGIN
    DECLARE id_alumno INT;
    DECLARE id_materia INT;
    DECLARE id_inscripcion_materia INT;
    DECLARE estado_inscripcion VARCHAR(20);
    DECLARE tiene_sin_calificacion BOOLEAN;

    SET id_alumno = (SELECT id_alumno FROM alumnos WHERE nombre = nombre_alumno AND apellido = apellido_alumno);
    SET id_materia = (SELECT id_materia FROM materias WHERE nombre = nombre_materia);
    SET id_inscripcion_materia = (SELECT id_inscripcion_materia FROM inscripcion_materia WHERE id_alumno = id_alumno AND id_materia = id_materia);
    SET estado_inscripcion = (SELECT estado FROM inscripcion_materia WHERE id_inscripcion_materia = id_inscripcion_materia);

    SET tiene_sin_calificacion = tiene_inscripcion_sin_calificacion(id_alumno, id_materia);

    IF tiene_sin_calificacion THEN
        SELECT 'No se puede inscribir en el examen. El alumno tiene inscripción previa sin calificación.' AS mensaje;
    ELSEIF estado_inscripcion = 'Regular' THEN
        INSERT INTO inscripcion_examen (id_alumno, id_mesa, fecha_inscripcion)
        VALUES (id_alumno, id_mesa, fecha_inscripcion);
        SELECT 'Inscripción en el examen realizada exitosamente.' AS mensaje;
    ELSE
        SELECT 'El alumno no está regular en la materia. No se puede inscribir en el examen.' AS mensaje;
    END IF;
END$$

DELIMITER ;
----------------------------------------------------------------------------------------------------------------
-- Para probar el procedimiento
CALL inscribir_en_examen('Juan', 'Pérez', 'Programacion I', 1, '2024-09-16');
